# Lambda関数は動的起動（オンデマンド起動・アイドル停止）

services:
  # ============================================
  # Permission Helper (RustFS用)
  # ============================================
  permission-helper:
    image: alpine
    container_name: onpre-permission-helper
    volumes:
      - rustfs_data:/data/rustfs
    command: >
      sh -c "
        chown -R 10001:10001 /data/rustfs 2>/dev/null || true && echo 'RustFS permissions fixed'
      "
    restart: "no"

  # ============================================
  # RustFS (S3 Compatible Storage)
  # ============================================
  s3-storage:
    image: rustfs/rustfs:latest
    container_name: onpre-storage
    depends_on:
      permission-helper:
        condition: service_completed_successfully
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # Console
    volumes:
      - rustfs_data:/data/rustfs
      - ./config/lifecycle.yml:/app/config/lifecycle.yml:ro
    environment:
      - RUSTFS_VOLUMES=/data/rustfs
      - RUSTFS_ADDRESS=0.0.0.0:9000
      - RUSTFS_ACCESS_KEY=${RUSTFS_ACCESS_KEY:-rustfsadmin}
      - RUSTFS_SECRET_KEY=${RUSTFS_SECRET_KEY:-rustfsadmin}
      - RUSTFS_CONSOLE_ENABLE=true
      - RUSTFS_CONSOLE_ADDRESS=0.0.0.0:9001
      - RUSTFS_DEDUPLICATION=${RUSTFS_DEDUPLICATION:-true}
      - RUSTFS_COMPRESSION=${RUSTFS_COMPRESSION:-auto}
      - RUSTFS_LIFECYCLE_POLICY_PATH=/app/config/lifecycle.yml
    healthcheck:
      test: [ "CMD", "sh", "-c", "curl -f http://127.0.0.1:9000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - external_network # 外部公開用
      - internal_network # Lambda間通信

  # ============================================
  # ScyllaDB (DynamoDB Compatible DB)
  # ============================================
  database:
    image: scylladb/scylla:latest
    container_name: onpre-database
    ports:
      - "8001:8000" # Alternator API (Host 8001 -> Container 8000)
    volumes:
      - scylladb_data:/var/lib/scylla
    command: --smp 1 --memory ${SCYLLADB_MEMORY:-1}G --developer-mode 1 --alternator-port 8000 --alternator-address 0.0.0.0 --alternator-write-isolation always_use_lwt
    healthcheck:
      test: [ "CMD-SHELL", "cqlsh -e 'DESCRIBE KEYSPACES' || exit 1" ]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 180s
    restart: unless-stopped
    networks:
      - external_network # 外部公開用
      - internal_network # Lambda間通信

  # ============================================
  # Fluent Bit (Log Aggregator)
  # ============================================
  fluent-bit:
    image: fluent/fluent-bit:latest
    container_name: fluent-bit
    ports:
      - "24224:24224"  # Forward protocol
    volumes:
      - ./config/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - ./config/parsers.conf:/fluent-bit/etc/parsers.conf:ro
      - ./config/append_container_name.lua:/fluent-bit/etc/append_container_name.lua:ro
    networks:
      - external_network
      - internal_network
    restart: unless-stopped

  # ============================================
  # VictoriaLogs
  # ============================================
  victorialogs:
    image: victoriametrics/victoria-logs:latest
    container_name: victorialogs
    ports:
      - "9428:9428" # VictoriaLogs UI/API
    volumes:
      - victorialogs_data:/victoria-logs-data
    command:
      - "-storageDataPath=/victoria-logs-data"
      - "-retentionPeriod=7d"
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://127.0.0.1:9428/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - external_network # 外部公開用
      - internal_network # Lambda間通信

  # ============================================
  # API Gateway (Facade)
  # ============================================
  gateway:
    image: gateway-api:latest
    build:
      context: .
      dockerfile: services/gateway/Dockerfile
    container_name: onpre-gateway
    networks:
      - external_network # Port exposure
      - internal_network # Internal communication
    ports:
      - "443:443" # HTTPS
    volumes:
      - ./certs:/app/config/ssl:ro
    environment:
      - UVICORN_BIND_ADDR=0.0.0.0:443
      - ENABLE_SSL=true
      - SSL_CERT_PATH=/app/config/ssl/server.crt
      - SSL_KEY_PATH=/app/config/ssl/server.key
      - MANAGER_URL=http://onpre-manager:8081
      - GATEWAY_INTERNAL_URL=https://onpre-gateway
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-dev-secret-key-change-in-production}
      - X_API_KEY=${X_API_KEY:-dev-api-key-change-in-production}
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "gateway"
        fluentd-async: "true"
    depends_on:
      fluent-bit:
        condition: service_started
      manager:
        condition: service_started
      database:
        condition: service_healthy
      s3-storage:
        condition: service_healthy
      victorialogs:
        condition: service_healthy
    restart: unless-stopped

  # ============================================
  # Container Manager (Orchestrator)
  # ============================================
  manager:
    image: container-manager:latest
    build:
      context: .
      dockerfile: services/manager/Dockerfile
    container_name: onpre-manager
    networks:
      - internal_network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Privileged access for Docker-in-Docker behavior
    environment:
      - CONTAINERS_NETWORK=${LAMBDA_NETWORK:-onpre-internal-network} # Internal test network
      - IDLE_TIMEOUT_MINUTES=${IDLE_TIMEOUT_MINUTES:-5}
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "manager"
        fluentd-async: "true"
    restart: unless-stopped

volumes:
  scylladb_data:
  rustfs_data:
  victorialogs_data:


networks:
  # 外部公開用ネットワーク（ポート公開）
  external_network:
    name: ${EXTERNAL_NETWORK:-onpre-external}
    driver: bridge
  # Lambda間通信専用ネットワーク（外部アクセス遮断）
  internal_network:
    name: ${LAMBDA_NETWORK:-onpre-internal-network}
    driver: bridge
    internal: true
